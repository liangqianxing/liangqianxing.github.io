<script>
(() => {
  const storageKey = 'theme-preference';
  const themeColors = {
    light: '#edf5ff',
    dark : '#071528'
  };
  const root = document.documentElement;
  const media = window.matchMedia('(prefers-color-scheme: dark)');
  const isValidTheme = value => value === 'dark' || value === 'light';
  const ensureThemeColorMeta = () => {
    let meta = document.querySelector('meta[name="theme-color"][data-managed="true"]');
    if (!meta) {
      meta = document.createElement('meta');
      meta.name = 'theme-color';
      meta.setAttribute('data-managed', 'true');
      document.head.appendChild(meta);
    }
    return meta;
  };

  const syncThemeColorMeta = effectiveTheme => {
    const meta = ensureThemeColorMeta();
    meta.content = effectiveTheme === 'dark' ? themeColors.dark : themeColors.light;
  };

  try {
    const savedTheme = localStorage.getItem(storageKey);
    const userTheme = isValidTheme(savedTheme) ? savedTheme : 'system';
    const effectiveTheme = userTheme === 'system' ? (media.matches ? 'dark' : 'light') : userTheme;

    root.dataset.userTheme = userTheme;
    root.dataset.themeEffective = effectiveTheme;

    if (userTheme === 'system') {
      root.style.removeProperty('color-scheme');
    } else {
      root.style.colorScheme = userTheme;
    }

    syncThemeColorMeta(effectiveTheme);
  } catch (error) {
    root.dataset.userTheme = 'system';
    root.dataset.themeEffective = media.matches ? 'dark' : 'light';
    syncThemeColorMeta(root.dataset.themeEffective);
  }
})();
</script>
