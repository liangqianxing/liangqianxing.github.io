<button class="theme-toggle-button" id="theme-toggle-float" type="button" aria-label="Switch to dark mode" title="Switch to dark mode">
  <i class="fa fa-moon theme-toggle-icon" aria-hidden="true"></i>
  <span class="theme-toggle-text">Dark Mode</span>
</button>

<script data-pjax>
(() => {
  const STORAGE_KEY = 'theme-preference';
  const THEME_LIGHT = 'light';
  const THEME_DARK = 'dark';
  const THEME_SYSTEM = 'system';
  const root = document.documentElement;
  const media = window.matchMedia('(prefers-color-scheme: dark)');

  const isValidTheme = theme => theme === THEME_DARK || theme === THEME_LIGHT;

  function getSavedTheme() {
    try {
      const value = localStorage.getItem(STORAGE_KEY);
      return isValidTheme(value) ? value : THEME_SYSTEM;
    } catch (error) {
      return THEME_SYSTEM;
    }
  }

  function getEffectiveTheme(theme) {
    if (isValidTheme(theme)) return theme;
    return media.matches ? THEME_DARK : THEME_LIGHT;
  }

  function ensureMenuToggle() {
    const menu = document.querySelector('.main-menu.menu');
    if (!menu) return null;

    let item = menu.querySelector('.menu-item-theme-toggle');
    if (!item) {
      item = document.createElement('li');
      item.className = 'menu-item menu-item-theme-toggle';
      item.innerHTML = '<a role="button"><i class="fa fa-moon fa-fw theme-menu-icon"></i><span class="theme-menu-text">Dark Mode</span></a>';
      const searchItem = menu.querySelector('.menu-item-search');
      if (searchItem) {
        menu.insertBefore(item, searchItem);
      } else {
        menu.appendChild(item);
      }
    }

    return item.querySelector('a');
  }

  function updateFloatingButton(effectiveTheme) {
    const button = document.getElementById('theme-toggle-float');
    if (!button) return;

    const icon = button.querySelector('.theme-toggle-icon');
    const text = button.querySelector('.theme-toggle-text');
    const isDark = effectiveTheme === THEME_DARK;
    const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';

    button.classList.toggle('is-dark', isDark);
    button.setAttribute('aria-label', label);
    button.title = label;

    if (icon) {
      icon.classList.toggle('fa-moon', !isDark);
      icon.classList.toggle('fa-sun', isDark);
    }
    if (text) text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  }

  function updateMenuButton(effectiveTheme) {
    const trigger = ensureMenuToggle();
    if (!trigger) return;

    const icon = trigger.querySelector('.theme-menu-icon');
    const text = trigger.querySelector('.theme-menu-text');
    const isDark = effectiveTheme === THEME_DARK;
    const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';

    trigger.setAttribute('aria-label', label);
    trigger.setAttribute('title', label);

    if (icon) {
      icon.classList.toggle('fa-moon', !isDark);
      icon.classList.toggle('fa-sun', isDark);
    }
    if (text) text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  }

  function updateButtons(effectiveTheme) {
    updateFloatingButton(effectiveTheme);
    updateMenuButton(effectiveTheme);
  }

  function bindToggle(trigger) {
    if (!trigger || trigger.dataset.bound === 'true') return;

    trigger.dataset.bound = 'true';
    trigger.addEventListener('click', event => {
      event.preventDefault();
      toggleTheme();
    });
  }

  function applyTheme(theme, persist) {
    const effectiveTheme = getEffectiveTheme(theme);
    root.dataset.userTheme = theme;
    root.dataset.themeEffective = effectiveTheme;

    if (isValidTheme(theme)) {
      root.style.colorScheme = theme;
    } else {
      root.style.removeProperty('color-scheme');
    }

    if (persist) {
      try {
        if (theme === THEME_SYSTEM) {
          localStorage.removeItem(STORAGE_KEY);
        } else {
          localStorage.setItem(STORAGE_KEY, theme);
        }
      } catch (error) {}
    }

    updateButtons(effectiveTheme);
  }

  function toggleTheme() {
    const currentTheme = getSavedTheme();
    const currentEffective = getEffectiveTheme(currentTheme);
    const nextTheme = currentEffective === THEME_DARK ? THEME_LIGHT : THEME_DARK;
    applyTheme(nextTheme, true);
  }

  function initThemeToggle() {
    bindToggle(document.getElementById('theme-toggle-float'));
    bindToggle(ensureMenuToggle());
    applyTheme(getSavedTheme(), false);
  }

  function syncSystemTheme() {
    if (getSavedTheme() === THEME_SYSTEM) {
      applyTheme(THEME_SYSTEM, false);
    }
  }

  if (typeof media.addEventListener === 'function') {
    media.addEventListener('change', syncSystemTheme);
  } else if (typeof media.addListener === 'function') {
    media.addListener(syncSystemTheme);
  }

  window.addEventListener('DOMContentLoaded', initThemeToggle);
  document.addEventListener('pjax:success', initThemeToggle);
  initThemeToggle();
})();
</script>
